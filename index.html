<html style="height:100%;">

<head style="height:100%;">
    <title>TATD</title>
    <style>
        #stage {
            width: 1000px;
            height: 600px;
            background-color: #222;
            top: 50%;
            left: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            border: 10px solid #222;
        }
        
        #stage>div {
            position: relative;
        }
        
        #left-panel {
            width: 250px;
            height: 90%;
            float: left;
            background-color: #333;
            border-right: 4px #bbb solid;
            box-sizing: border-box;
        }
        
        #right-panel {
            margin-left: 250px;
            height: 90%;
            background-color: #333;
            box-sizing: content-box;
        }
        
        #right-panel .ftr {
            height: 40px;
            width: 100%;
            background: #111;
            position: absolute;
            bottom: 0px;
            text-align: center;
            /*            display: inline-block;*/
        }
        
        .ftr .speed {
            display: inline-block;
            width: 30%;
            position: absolute;
            left: 0px;
            height: 100%;
            float: left;
        }
        
        .ftr .speed button {
            width: 33%;
            /*            height: 100%;*/
            
            margin: 0px;
            /*            box-sizing: border-box;*/
        }
        
        .ftr button {
            height: 39px;
            position: relative;
            bottom: -1px;
        }
        
        .start {
            display: inline-block;
            width: 33%;
            position: absolute;
            left: 30%;
            height: 100%;
        }
        
        .start button {
            width: 100%;
            /*            height: 38px;*/
            
            margin: 0px;
            box-sizing: border-box;
        }
        
        .top-btn {
            background: #595B5B;
            box-shadow: 0 0 0 1px #303233;
            border: none;
            border-top: 1px solid #666767;
            color: #FFF;
            text-shadow: 0 -1px 0 #000;
            padding: 3px 20px 4px 8px;
            -webkit-appearance: none;
            padding-left: 0px;
            padding-right: 0px;
            font-size: 22px;
            text-align: center;
            position: relative;
            bottom: -1px;
        }
        
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /*            box-sizing: border-box;*/
        }
        
        .src {
            float: right;
            width: 35%;
            color: #ddd;
            line-height: 40px;
        }
        
        .src a {
            color: steelblue;
        }
        
        #head {
            height: 10%;
            background: #333;
            border-bottom: 4px #bbb solid;
            text-align: center;
            box-sizing: border-box;
        }
        
        #head>#title {
            color: #F0F1F1;
            font-size: 35px;
            top: 50%;
            left: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            font-family: Arial, Verdana, Sans-serif;
        }
        
        #mn {
            background-color: white;
            height: 100%;
            padding-bottom: 40px;
            box-sizing: border-box;
        }
        
        .grid {
            box-sizing: border-box;
            height: 50px;
            width: 50px;
            /*            border:1px black solid;*/
            
            display: inline-block;
            -webkit-transition: 0.1s linear;
            -o-transition: 0.1s linear;
            transition: 0.1s linear;
            /*
            border-right: 1px rgba(0,0,0,0) solid;
            border-bottom: 1px rgba(0,0,0,0) solid;
*/
            
            border: 3px rgba(0, 0, 0, 0) solid;
        }
        
        .grid[lang=wall]:hover {
            border-color: steelblue;
            cursor: pointer;
        }
        
        .grid[lang=wall] {
            background-color: #444;
            /*            border: */
            /*
            border-right:1px #555 solid;
            border-bottom:1px #555 solid;
*/
        }
        
        .grid[lang=road] {
            background-color: #222;
        }
        
        .grid[lang=start] {
            background-color: lightsteelblue;
        }
        
        .grid[lang=end] {
            background-color: steelblue;
        }
        
        .emy {
            height: 10px;
            width: 10px;
            position: absolute;
            left: 0px;
            top: 0px;
            background-color: antiquewhite;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body style="background-color:#4A4D4E;height:100%;margin:0px;">

    <div id="stage">
        <div id="head">
            <label id="title">LV1&nbsp;-&nbsp;TA</label>
        </div>
        <div id="left-panel">

        </div>
        <div id="right-panel">
            <div id="mn">
                <div class="emy emy_test" style="visibility:hidden;">

                </div>
            </div>
            <div class="ftr">
                <span class="speed">
                    <button class="top-btn">&times;1</button><button class="top-btn">&times;2</button><button class="top-btn">&times;4</button>
                </span>
                <div class="start">
                    <button class="top-btn">Start</button>
                </div>
                <div class="src">
                    TATD for <a href="http://2015.js13kgames.com/" target="_Blank">js13kgames</a> by <a href="https://github.com/blackmiaool" target="_Blank">blackmiaool</a>
                </div>
            </div>
        </div>
    </div>


</body>
<script>
    window.onload = function () {
        //        var $=HTMLSelectElement;
        var level = 0;
        var doc = document;
        var csl = console;
        var emys = [];
        var emy_tests=doc.getElementsByClassName("emy_test");
//        csl.log(emy_tests);
        var emys_height=[];
        var emys_width=[];
        for(var i =0;i<emy_tests.length;i++){
            emys_height.push(emy_tests[i].offsetHeight)
            emys_width.push(emy_tests[i].offsetWidth)
        }
//        csl.log(emys_height);
        
        var maps = [
            [
                "111111111111111",
                "111111111111111",
                "000000000000001",
                "111111111111101",
                "100000000000001",
                "101111111111111",
                "101111111111111",
                "100000000000000",
                "111111111111111",
                "111111111111111",
            ],
        ]
        var maps_start = [
            [0, 2],
        ]
        var maps_end = [
            [14, 7],
        ]
        var row_sum = 10;
        var column_sum = 15;
        csl.log(maps)
        var mn = doc.querySelector("#mn");
        var grids = [];
        function obj_add(target,src){
            for (var i in src) {
                target[i] = src[i];
            }
        }
//        Object.prototype.add = function (to_add) {
//            
//        }

        function get_bit(num, pos) {
            return Math.floor(num / Math.pow(2, pos)) % 2;
        }
        var toi = parseInt;

        function put() {
            csl.log.apply(csl, arguments);
        }

        //        console.log(get_bit(7, 1));

        function get_pos_value(map, x, y) {
            //            console.log(map, x, y)
            return parseInt(map[y][x]);
        }

        for (var i = 0; i < row_sum * column_sum; i++) {
            var x = toi(i / column_sum);
            var y = i % column_sum;
            if (!grids[y]) {
                grids[y] = [];
            }
            var node = doc.createElement("div");
            grids[y][x] = node;

            node.className = "grid";
            mn.appendChild(node);
        }
        //        put(grids);
        var start_grid = doc.querySelector(".grid");
        //        put( );
        function enter_level(level) {
            load_map(level);
            var map = maps[level];
            map_start = maps_start[level];
            map_end = maps_end[level];

            function load_map(level) {
                for (var row = 0; row < row_sum; row++) {
                    var row_value = parseInt(maps[level][row], 2);
                    for (var column = 0; column < column_sum; column++) {
                        //                    grids[column][row].lang = get_bit(row_value, column_sum - column - 1) ? "wall" : "road";
                        grids[column][row].lang = get_pos_value(maps[level], column, row) ? "wall" : "road";
                    }
                }
                grids[maps_start[level][0]][maps_start[level][1]].lang = "start";
                grids[maps_end[level][0]][maps_end[level][1]].lang = "end";

            }

            function get_grid(x, y) {
                return get_bit(map[y], x);
            }

            function dirs_create() { //this function can be replaced by direct array;
                var dirs = []; //0:up,1:right,2:down,3:left
                var cnt = 0;

                function handle_grid(start, end, pre) {

                    function get_next(start, pre) {
                        var state = false;
                        var dir;

                        function search(x, y) {
                            if (pre) {
                                if (x == pre[0] && y == pre[1])
                                    return;
                            }
                            if (!get_pos_value(map, x, y)) {
                                state = true;
                            }
                            return [false, x, y]
                        }
                        if (start[0] != 0) {
                            var result = search(start[0] - 1, start[1]);
                            if (state) {
                                result[0] = 3; //left
                                return result;
                            }
                        }
                        if (start[1] != 0) {
                            var result = search(start[0], start[1] - 1);
                            if (state) {
                                result[0] = 0; //up
                                return result;
                            }
                        }
                        if (start[0] != column_sum) {
                            var result = search(start[0] + 1, start[1]);
                            if (state) {
                                result[0] = 1; //right
                                return result;
                            }
                        }
                        if (start[1] != row_sum) {
                            var result = search(start[0], start[1] + 1);
                            if (state) {
                                result[0] = 2; //down
                                return result;
                            }
                        }
                    }
                    var next = get_next(start, pre);
                    dirs.push(next[0]);
                    var pre = start;
                    start = [next[1], next[2]];
                    console.log(start)
                    cnt++;
                    if (cnt == 100)
                        return;
                    if (start[0] == end[0] && start[1] == end[1]) {
                        return;
                    } else {
                        handle_grid(start, end, pre);
                    }

                }
                handle_grid(map_start, map_end)
                put(dirs);
                return dirs;
            }
            var dirs = dirs_create();

            function start() {

            }



            function get_grid_pos(pos) {
                var h = start_grid.offsetHeight;
                var w = start_grid.offsetWidth;
                return [(pos[0] + 0.5) * h, (pos[1] + 0.5) * w]


            }


            var emy_create = function (kind) {
                var emy = doc.createElement("div");
                emy.className = "emy";
                
                var style = emy.style;
                emy.set_pos = function (pos) {
                    var array = get_grid_pos(pos);
                    obj_add(style,{
                        "left": array[0],
                        "top": array[1]
                    })
                }
                emy.register = function () {
                    emys.push(emy);
                    
                }
                var pos;
                var dir;
                var speed=10;//pixel per sec
                function goto(x,y){
                    x-=emys_width[kind]/2;
                    y-=emys_height[kind]/2;
//                    csl.log(x,y);
                    emy.style.transform="translate("+x+"px,"+y+"px)";
//                    emy.style.left=x+"px";
//                    emy.style.top=y+"px";

                }
                var x=0;
                var y=0;
                emy.step=function(){//called 60 times per sec 
                    
//                csl.log(height,width) 
                    if(!dir)//uninited
                    { 
                        dir=dirs[0];
                        pos=map_start;
                        emy.set_pos(maps_start[level]);
                    }
                    goto(x,y++);     
                    
                }
                return emy;
            } 

            function put_emy(kind) {
                var emy = emy_create(kind);

                
                emy.register()
                mn.appendChild(emy);

            }
            put_emy(0);

        }
        enter_level(0);







        csl.log(emys)
        var cnt=1;
        function step() {
//            csl.log(cnt++);
            for(var i in emys){
               
//                csl.log(emys[i].step)
                emys[i].step();
            }




            requestAnimationFrame(step);
        }

        requestAnimationFrame(step);


    }
</script>

</html>